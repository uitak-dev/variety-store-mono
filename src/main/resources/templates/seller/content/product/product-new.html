<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{seller/layout/base :: common_head(~{::title}, ~{::link})}">
    <title>상품 등록</title>
</head>

<body>
<header th:replace="~{seller/layout/base :: common_header}"></header>
<aside th:replace="~{seller/layout/base :: common_aside}"></aside>

<!-- 메인 컨텐츠 -->
<div class="main-content">
    <section class="container-fluid">

        <!-- 페이지 제목 -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="fw-bold">상품 등록</h2>
                <p class="mb-0">판매할 상품을 등록하세요.</p>
            </div>
        </div>

        <!-- 카드 영역 -->
        <div class="row g-3 mb-4">
            <div class="col-md-12">
                <!-- 상품 등록 폼: 기본 정보와 옵션 정보를 JSON으로 전송 -->
                <form id="productForm" data-mode="new" method="post">
                    <!-- 기본 정보 섹션 -->
                    <section class="card card-section mb-4">
                        <div class="card-header">기본 정보</div>
                        <div class="card-body">
                            <!-- 상품 카테고리 선택 영역 -->
                            <div class="mb-3">
                                <label for="selectedParent" class="form-label">상품 카테고리 선택:</label>
                                <div class="input-group">
                                    <input type="text" id="selectedParent" class="form-control" placeholder="상품 카테고리 선택" readonly>
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal"
                                            data-bs-target="#categoryModal">선택</button>
                                </div>
                                <!-- 선택된 상품 카테고리 id를 저장 -->
                                <input type="hidden" id="categoryId" name="categoryId" value="" required>
                            </div>

                            <div class="mb-3">
                                <label for="name" class="form-label">상품 이름</label>
                                <input type="text" id="name" class="form-control" placeholder="상품명을 입력하세요" required>
                            </div>

                            <!-- 썸네일 업로드 -->
                            <div class="mb-3">
                                <label for="thumbnail" class="form-label">썸네일 이미지</label>
                                <input class="form-control" type="file" id="thumbnail" name="thumbnail"
                                       accept="image/*" required>
                                <div id="thumbnailPreview" class="preview-container"></div>
                            </div>

                            <!-- 추가 상품 이미지 (최대 4장) -->
                            <div class="mb-3">
                                <label for="images" class="form-label">추가 상품 이미지 (최대 4장)</label>
                                <input class="form-control" type="file" id="images" name="images"
                                       multiple accept="image/*" required>
                                <div id="imagesPreview" class="preview-container"></div>
                            </div>

                            <div class="mb-3">
                                <label for="description" class="form-label">상품 설명</label>
                                <textarea id="description" class="form-control" rows="4" placeholder="상품 설명을 입력하세요"
                                          required></textarea>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="basePrice" class="form-label">가격</label>
                                    <input type="number" id="basePrice" class="form-control" placeholder="가격 입력" required
                                           step="0.01">
                                </div>
                                <div class="col-md-4">
                                    <label for="manufactureDate" class="form-label">제조일자</label>
                                    <input type="date" id="manufactureDate" class="form-control" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">상품 타입</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="singleProduct" name="single"
                                           value="true" checked required>
                                    <label class="form-check-label" for="singleProduct">단일 상품</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" id="optionProduct" name="single"
                                           value="false" required>
                                    <label class="form-check-label" for="optionProduct">옵션 상품</label>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 옵션 정보 섹션: 단일 상품일 경우만 노출 -->
                    <section class="card card-section mb-4" id="singleSection" style="display: block;">
                        <div class="card-header">단일 상품</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="stockQuantity" class="form-label">재고 수량</label>
                                <input type="number" id="stockQuantity" class="form-control" placeholder="재고 수량 입력">
                            </div>
                        </div>
                    </section>

                    <!-- 옵션 정보 섹션: 옵션 상품일 경우만 노출 -->
                    <section class="card card-section mb-4" id="optionSection" style="display: none;">
                        <div class="card-header">옵션 정보 등록</div>
                        <div class="card-body">
                            <button type="button" id="loadTemplateButton" class="btn btn-outline-info mb-3">옵션 템플릿 불러오기</button>
                            <button type="button" id="addManualOptionButton" class="btn btn-outline-primary mb-3">옵션 추가</button>
                            <div id="productOptionsContainer"></div>
                        </div>
                    </section>

                    <!-- 제출 및 취소 버튼 -->
                    <div class="row">
                        <div class="col">
                            <button type="submit" class="w-100 btn btn-primary">상품 등록</button>
                        </div>
                        <div class="col">
                            <button type="button" class="w-100 btn btn-secondary"
                                    th:onclick="|location.href='@{/seller/products}'|">취소</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </section>
</div>

<!-- 모달 팝업: 동적으로 카테고리 선택 -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalLabel">상위 카테고리 선택</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <!-- Breadcrumb 영역 -->
                <nav aria-label="breadcrumb">
                    <ol id="breadcrumbContainer" class="breadcrumb">
                        <!-- 동적으로 breadcrumb 항목이 추가됩니다 -->
                    </ol>
                </nav>
                <!-- 동적으로 로드될 카테고리 목록 -->
                <div id="categoryListContainer" class="category-tree">
                    <!-- AJAX로 카테고리 목록이 로드됩니다 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="goBack()">이전</button>
                <button type="button" id="confirmBtn" class="btn btn-primary" onclick="confirmSelection()" disabled>선택 완료</button>
            </div>
        </div>
    </div>
</div>

<!-- 옵션 템플릿 모달 -->
<div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="templateModalLabel">옵션 템플릿 선택</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="닫기"></button>
            </div>
            <div class="modal-body">
                <div id="templateModalContainer" class="row row-cols-1 row-cols-md-2 g-4">
                    <!-- 데이터 추가. -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{seller/layout/base :: common_footer}"></footer>
<script src="/seller/js/productForm.js"></script>
<script src="/seller/js/productNew.js"></script>
<script>
    // 전역 변수: 현재 선택한 카테고리 id 및 breadcrumb 스택
    let currentParentId = null;
    let breadcrumbStack = [];

    // 최상위 또는 하위 카테고리 목록을 비동기로 로드하는 함수
    async function loadCategories(parentId) {
        const container = document.getElementById("categoryListContainer");
        const confirmBtn = document.getElementById("confirmBtn");
        container.innerHTML = "";
        confirmBtn.disabled = true;    // 일단 비활성화

        let url = parentId
            ? `/api/categories/children?categoryId=${parentId}`
            : "/api/categories/children";

        try {
            const response = await fetch(url);
            const categories = await response.json();

            if (categories.length === 0) {
                // 더 이상 하위가 없으면 “선택 완료” 활성화
                container.innerHTML = "<p>더 이상 하위 카테고리가 없습니다.</p>";
                confirmBtn.disabled = false;
            } else {
                // 하위가 있으면 여전히 비활성화
                const ul = document.createElement("ul");
                ul.classList.add("list-group");
                categories.forEach(cat => {
                    const li = document.createElement("li");
                    li.classList.add("list-group-item", "list-group-item-action");
                    li.textContent = cat.name;
                    li.style.cursor = "pointer";
                    li.onclick = () => {
                        currentParentId = cat.id;
                        breadcrumbStack.push({ id: cat.id, name: cat.name });
                        updateBreadcrumb();
                        loadCategories(cat.id);
                    };
                    ul.appendChild(li);
                });
                container.appendChild(ul);
            }
        } catch (error) {
            console.error("카테고리 로드 실패:", error);
        }
    }

    // 브레드크럼 업데이트: 현재까지 선택한 경로를 표시
    function updateBreadcrumb() {
        const breadcrumbContainer = document.getElementById("breadcrumbContainer");
        breadcrumbContainer.innerHTML = "";
        breadcrumbStack.forEach((item, index) => {
            const span = document.createElement("span");
            span.textContent = item.name;
            span.style.cursor = "pointer";
            span.onclick = function () {
                // 해당 브레드크럼 항목 클릭 시 해당 레벨로 돌아가기
                breadcrumbStack = breadcrumbStack.slice(0, index + 1);
                currentParentId = item.id;
                updateBreadcrumb();
                loadCategories(item.id);
            };
            breadcrumbContainer.appendChild(span);
            if (index < breadcrumbStack.length - 1) {
                const sep = document.createElement("span");
                sep.textContent = " > ";
                breadcrumbContainer.appendChild(sep);
            }
        });
    }

    // 이전 버튼: breadcrumb에서 마지막 항목 제거 후 이전 레벨로 이동
    function goBack() {
        if (breadcrumbStack.length > 0) {
            breadcrumbStack.pop();
            currentParentId = breadcrumbStack.length > 0 ? breadcrumbStack[breadcrumbStack.length - 1].id : null;
            updateBreadcrumb();
            loadCategories(currentParentId);
        } else {
            loadCategories(null);
        }
    }

    // 선택 완료 버튼: breadcrumb의 마지막 항목을 최종 선택으로 반영하여 폼에 업데이트
    function confirmSelection() {
        let selectedCategory = breadcrumbStack.length > 0 ? breadcrumbStack[breadcrumbStack.length - 1] : null;
        if (selectedCategory) {
            document.getElementById("selectedParent").value = breadcrumbStack.map(item => item.name).join(" > ");
            document.getElementById("categoryId").value = selectedCategory.id;
        } else {
            document.getElementById("selectedParent").value = "";
            document.getElementById("categoryId").value = "";
        }
        // 모달 닫기
        const modalEl = document.getElementById("categoryModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();
    }

    // 모달이 열릴 때 초기 상태 설정: 최상위 카테고리 로드 및 breadcrumb 초기화
    document.getElementById("categoryModal").addEventListener('shown.bs.modal', function () {
        breadcrumbStack = [];
        currentParentId = null;
        updateBreadcrumb();
        loadCategories(null);
        document.getElementById("confirmBtn").disabled = true;
    });


    // 옵션 템플릿 선택
    $(document).ready(function () {
        // 1. 검색 인풋: 왼쪽 목록 필터링
        $("#searchInput").on("input", function () {
            var searchTerm = $(this).val().toLowerCase();
            $("#availableItemsList li").each(function () {
                var text = $(this).text().toLowerCase();
                $(this).toggle(text.indexOf(searchTerm) > -1);
            });
        });

        // 2. 왼쪽 목록의 아이템 클릭 시 오른쪽 패널로 이동 (애니메이션 없이 즉시 이동)
        $("#availableItemsList").on("click", "li", function () {
            $(this).detach().appendTo("#selectedItemsList");
        });

        // 3. 오른쪽 목록의 아이템 클릭 시 왼쪽 패널로 이동
        $("#selectedItemsList").on("click", "li", function () {
            $(this).detach().appendTo("#availableItemsList");
        });

        // 4. 폼 제출 시, 각 li의 value 속성을 수집하여 hidden input에 설정
        $("#categoryForm").on("submit", function () {
            var selectedOptionIds = [];
            $("#selectedItemsList li").each(function () {
                selectedOptionIds.push($(this).attr("value"));
            });
            $("#optionIds").val(selectedOptionIds.join(","));
        });
    });
</script>
</body>
</html>